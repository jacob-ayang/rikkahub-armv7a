name: Sync Fork

on:
  schedule:
    # 每 10 分钟检查 upstream 更新（用于测试/调试）
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      upstream_tag: ${{ steps.check_release.outputs.upstream_tag }}
      upstream_version: ${{ steps.sync_upstream_version.outputs.new_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/rikkahub/rikkahub.git || true
          # 获取 upstream master 分支（忽略 tag 冲突错误）
          git fetch upstream master 2>&1 || true
          # 同步 tags
          git fetch upstream --tags 2>&1 || true
          echo "=== Upstream master ===" 
          git log --oneline -1 upstream/master 2>/dev/null || echo "⚠️ No upstream/master yet"

      - name: Check for changes
        id: check_changes
        run: |
          # 比较本地和上游的提交
          LOCAL_COMMIT=$(git rev-parse master)
          UPSTREAM_COMMIT=$(git rev-parse upstream/master)
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✅ Upstream has new commits"
            
            # 显示差异
            echo "=== New commits from upstream ==="
            git log --oneline $LOCAL_COMMIT..$UPSTREAM_COMMIT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "⏭️  Already up to date"
          fi

      - name: Check for upstream releases
        id: check_release
        run: |
          # 获取最新的上游 release tag
          LATEST_UPSTREAM_TAG=$(git describe --tags --abbrev=0 upstream/master 2>/dev/null || echo "none")
          LATEST_LOCAL_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          
          echo "latest_upstream_tag=$LATEST_UPSTREAM_TAG" >> $GITHUB_OUTPUT
          echo "latest_local_tag=$LATEST_LOCAL_TAG" >> $GITHUB_OUTPUT
          
          echo "Latest upstream tag: $LATEST_UPSTREAM_TAG"
          echo "Latest local tag: $LATEST_LOCAL_TAG"
          
          if [ "$LATEST_UPSTREAM_TAG" != "$LATEST_LOCAL_TAG" ] && [ "$LATEST_UPSTREAM_TAG" != "none" ]; then
            echo "upstream_tag=$LATEST_UPSTREAM_TAG" >> $GITHUB_OUTPUT
            echo "✅ Upstream has new release: $LATEST_UPSTREAM_TAG"
          fi

      - name: Merge upstream changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "Merging upstream/master..."
          git merge upstream/master -m "chore: sync upstream changes" || {
            # 如果 merge 失败（可能是冲突），中止
            if git status | grep -q "both modified"; then
              echo "⚠️  Conflicts detected, aborting merge"
              git merge --abort
              exit 1
            fi
            exit 1
          }
          
          # 检查是否有未推送的更改
          if ! git diff --quiet origin/master; then
            echo "Pushing merged changes..."
            git push origin master
            echo "✅ Successfully merged and pushed upstream changes"
          else
            echo "✅ Merge completed (no new commits to push)"
          fi

      - name: Get current version
        id: current_version
        run: |
          VERSION=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts | head -1)
          CODE=$(grep -oP 'versionCode = \K[0-9]+' app/build.gradle.kts | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "code=$CODE" >> $GITHUB_OUTPUT
          echo "Current: versionCode=$CODE, versionName=$VERSION"

      - name: Bump version for prerelease
        id: bump_version
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # 获取当前版本
          CURRENT_VERSION=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts | head -1)
          CURRENT_CODE=$(grep -oP 'versionCode = \K[0-9]+' app/build.gradle.kts | head -1)
          
          # 升级 PATCH 版本
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_PATCH=$((patch + 1))
          NEW_VERSION="${major}.${minor}.${NEW_PATCH}"
          NEW_CODE=$((CURRENT_CODE + 1))
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_code=$NEW_CODE" >> $GITHUB_OUTPUT
          echo "Bumping version: $CURRENT_VERSION → $NEW_VERSION"
          
          # 更新 build.gradle.kts
          sed -i "s/versionCode = $CURRENT_CODE/versionCode = $NEW_CODE/" app/build.gradle.kts
          sed -i "s/versionName = \"$CURRENT_VERSION\"/versionName = \"$NEW_VERSION\"/" app/build.gradle.kts
          
          # 提交版本更新（如果有更改则提交）
          if git diff --quiet app/build.gradle.kts; then
            echo "No version changes needed"
          else
            git add app/build.gradle.kts
            git commit -m "chore: bump version to $NEW_VERSION for sync"
            git push origin master
            echo "✅ Version bumped to $NEW_VERSION (code: $NEW_CODE)"
          fi

      - name: Sync upstream release version
        id: sync_upstream_version
        if: steps.check_release.outputs.upstream_tag != ''
        run: |
          UPSTREAM_TAG="${{ steps.check_release.outputs.upstream_tag }}"
          
          # 从 tag 中提取版本号（移除 v 前缀）
          UPSTREAM_VERSION="${UPSTREAM_TAG#v}"
          
          echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          echo "new_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          
          # 获取当前版本
          CURRENT_VERSION=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts | head -1)
          CURRENT_CODE=$(grep -oP 'versionCode = \K[0-9]+' app/build.gradle.kts | head -1)
          
          echo "Current version: $CURRENT_VERSION"
          echo "Upstream version: $UPSTREAM_VERSION"
          
          # 检查是否需要更新
          if [ "$CURRENT_VERSION" != "$UPSTREAM_VERSION" ]; then
            NEW_CODE=$((CURRENT_CODE + 1))
            
            echo "Syncing to upstream version: $UPSTREAM_VERSION (code: $NEW_CODE)"
            
            # 更新 build.gradle.kts
            sed -i "s/versionCode = $CURRENT_CODE/versionCode = $NEW_CODE/" app/build.gradle.kts
            sed -i "s/versionName = \"$CURRENT_VERSION\"/versionName = \"$UPSTREAM_VERSION\"/" app/build.gradle.kts
            
            # 提交版本更新
            git add app/build.gradle.kts
            git commit -m "chore: sync version to upstream $UPSTREAM_VERSION"
            git push origin master
            
            echo "✅ Version synced to $UPSTREAM_VERSION (code: $NEW_CODE)"
          else
            echo "✅ Already at upstream version $UPSTREAM_VERSION"
          fi

  trigger-build:
    needs: sync-fork
    runs-on: ubuntu-latest
    if: needs.sync-fork.outputs.upstream_tag != ''
    
    steps:
      - name: Trigger Build ARM V7
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('Triggering build-armv7 in release mode');
            
            const workflow = await github.rest.actions.getWorkflow({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-armv7.yml'
            });
            
            const dispatch = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow.data.id,
              ref: 'master',
              inputs: {
                release_type: 'release'
              }
            });
            
            console.log(`✅ Build workflow triggered with status: ${dispatch.status}`);
