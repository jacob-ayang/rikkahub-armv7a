name: Build Universal

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (draft/prerelease/release)'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - prerelease
          - release
  push:
    branches:
      - master
    paths:
      - 'app/src/**'
      - 'ai/src/**'
      - 'common/src/**'
      - 'highlight/src/**'
      - 'search/src/**'
      - 'tts/src/**'
      - 'document/src/**'
      - 'app/build.gradle.kts'
      - 'build.gradle.kts'
      - '.github/workflows/build-universal.yml'

permissions:
  contents: write
  packages: read

jobs:
  build-universal:
    runs-on: ubuntu-latest
    name: Build Universal Release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36
          ndk-version: 27.0.11902837

      - name: Validate build configuration
        id: validate
        run: |
          echo "Validating universal build prerequisites..."
          
          # Check for required secrets
          if [ -z "${{ secrets.KEY_BASE64 }}" ]; then
            echo "ERROR: Missing required secret (KEY_BASE64)"
            exit 1
          fi
          
          # Check if google-services.json exists in repo
          if [ ! -f "app/google-services.json" ]; then
            echo "ERROR: app/google-services.json not found"
            exit 1
          fi
          
          echo "âœ“ All required configuration found"
          echo "validation_passed=true" >> $GITHUB_OUTPUT

      - name: Prepare signing credentials
        if: steps.validate.outputs.validation_passed == 'true'
        run: |
          # Decode and store keystore in project root
          echo "${{ secrets.KEY_BASE64 }}" | base64 -d > rikkahub.keystore
          
          # Create local.properties with signing config (using relative path from project root)
          cat > local.properties << 'EOF'
          storeFile=rikkahub.keystore
          storePassword=rikkahub@123
          keyAlias=rikkahub
          keyPassword=rikkahub@123
          EOF
          
          echo "âœ“ Build credentials prepared"

      - name: Extract version information
        id: version
        run: |
          VERSION_NAME=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts | head -1)
          VERSION_CODE=$(grep -oP 'versionCode = \K[0-9]+' app/build.gradle.kts | head -1)
          BUILD_TIMESTAMP=$(date -u +'%Y%m%d_%H%M%S')
          BUILD_DATE=$(date -u +'%Y-%m-%d')
          
          echo "version_name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "build_timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          
          echo "Build Info: Version $VERSION_NAME (Code: $VERSION_CODE)"

      - name: Build Universal Release APK
        run: |
          chmod +x gradlew
          ./gradlew clean assembleUniversalRelease \
            -Pandroid.injected.build.model=full \
            -Porg.gradle.jvmargs="-Xmx4096m" \
            --stacktrace
        env:
          GRADLE_OPTS: "-Xmx4096m -XX:+UseG1GC"

      - name: Verify build output
        id: verify
        run: |
          echo "Verifying universal build outputs..."
          
          # Find the generated APK
          APK_PATH=$(find app/build/outputs/apk -name "*universal*release*.apk" -type f | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "ERROR: Universal APK not found in build outputs"
            echo "Available outputs:"
            find app/build/outputs -type f -name "*.apk" || true
            exit 1
          fi
          
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          APK_NAME=$(basename "$APK_PATH")
          
          echo "âœ“ APK found: $APK_NAME ($APK_SIZE)"
          echo "apk_path=${APK_PATH}" >> $GITHUB_OUTPUT
          echo "apk_name=${APK_NAME}" >> $GITHUB_OUTPUT
          echo "apk_size=${APK_SIZE}" >> $GITHUB_OUTPUT

      - name: Rename and organize artifacts
        id: artifacts
        run: |
          mkdir -p build-output
          
          APK_PATH="${{ steps.verify.outputs.apk_path }}"
          NEW_NAME="rikkahub-${{ steps.version.outputs.version_name }}-universal-${{ steps.version.outputs.build_timestamp }}.apk"
          
          cp "$APK_PATH" "build-output/$NEW_NAME"
          
          echo "âœ“ APK renamed: $NEW_NAME"
          echo "artifact_name=${NEW_NAME}" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: rikkahub-universal-${{ steps.version.outputs.version_name }}
          path: build-output/
          retention-days: 30
          if-no-files-found: error

      - name: Create GitHub Release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          files: build-output/*.apk
          tag_name: v${{ steps.version.outputs.version_name }}-universal-${{ steps.version.outputs.build_timestamp }}
          name: RikkaHub v${{ steps.version.outputs.version_name }} - Universal
          draft: ${{ github.event.inputs.release_type == 'draft' }}
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
          body: |
            # RikkaHub Universal Build
            
            **Version:** v${{ steps.version.outputs.version_name }} (Code: ${{ steps.version.outputs.version_code }})
            **Build Date:** ${{ steps.version.outputs.build_date }}
            **Architecture:** arm64-v8a + x86_64
            **Size:** ${{ steps.verify.outputs.apk_size }}
            
            ## About this Build
            - Supports both 64-bit ARM and x86 architectures
            - Built from commit: ${{ github.sha }}
            
            ## Installation
            1. Download the `.apk` file below
            2. Transfer to your Android device
            3. Go to **Settings > Security > Unknown Sources** and enable installation from unknown sources
            4. Tap the APK file to install
            
            ## Supported Devices
            - **CPU:** arm64-v8a or x86_64 (64-bit) processors
            - **Android Version:** 8.0+ (API Level 26+)
            
            ## Features
            - Full feature support
            - Optimized for modern 64-bit devices
            - Better performance on recent Android phones
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish build summary
        if: always()
        run: |
          {
            echo "## ðŸ“¦ Universal Build Summary"
            echo ""
            echo "| Item | Value |"
            echo "|------|-------|"
            echo "| Version | v${{ steps.version.outputs.version_name }} |"
            echo "| Build Date | ${{ steps.version.outputs.build_date }} |"
            echo "| Architecture | arm64-v8a + x86_64 (64-bit) |"
            echo "| Status | ${{ job.status }} |"
            
            if [ -n "${{ steps.verify.outputs.apk_size }}" ]; then
              echo "| APK Size | ${{ steps.verify.outputs.apk_size }} |"
              echo "| Artifact | ${{ steps.artifacts.outputs.artifact_name }} |"
            fi
          } >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Build completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Build failed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup sensitive files
        if: always()
        run: |
          # Clean up sensitive files to avoid accidental leaks
          rm -f local.properties rikkahub.keystore app/app.key
